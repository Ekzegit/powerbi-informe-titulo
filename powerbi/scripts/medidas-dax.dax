/*
================================================================================
MEDIDAS DAX - AN√ÅLISIS DE COMPRAS P√öBLICAS
================================================================================
Proyecto:     An√°lisis de Compras P√∫blicas - Senado de la Rep√∫blica
Descripci√≥n:  Colecci√≥n completa de medidas DAX para an√°lisis de compras
Autor:        Ekzegit
Fecha:        Febrero 2026
Versi√≥n:      1.0
================================================================================

CONTENIDO:
1. KPIs Principales (8 medidas)
2. An√°lisis Temporal (7 medidas)
3. An√°lisis de Proveedores (6 medidas)
4. An√°lisis de Productos (7 medidas)
5. An√°lisis Geogr√°fico (4 medidas)

TOTAL: 32 Medidas DAX

INSTRUCCIONES:
- Copiar cada medida en Power BI Desktop
- Ir a "Vista de Datos" o "Vista de Informe"
- Clic derecho en la tabla FactCompras > "Nueva medida"
- Pegar la f√≥rmula DAX
- Configurar formato seg√∫n el tipo de medida

================================================================================
*/

-- ============================================================================
-- SECCI√ìN 1: KPIs PRINCIPALES
-- ============================================================================

-- üìä TOTAL MONTO TRANSADO
-- Suma total de todos los montos de las transacciones
Total Monto Transado = 
SUM(FactCompras[Monto Transado])
-- Formato: $ Espa√±ol, 2 decimales

-- üì¶ TOTAL CANTIDAD PRODUCTOS
-- Suma total de unidades compradas
Total Cantidad Productos = 
SUM(FactCompras[Cantidad])
-- Formato: N√∫mero entero, separador de miles

-- üí∞ PRECIO PROMEDIO GENERAL
-- Calcula el precio promedio ponderado de todos los productos
Precio Promedio General = 
DIVIDE(
    SUM(FactCompras[Monto Transado]),
    SUM(FactCompras[Cantidad]),
    0
)
-- Formato: $ Espa√±ol, 2 decimales

-- üè¢ N√öMERO DE PROVEEDORES √öNICOS
-- Cuenta proveedores distintos que han vendido
N√∫mero Proveedores √önicos = 
DISTINCTCOUNT(FactCompras[Rut Proveedor])
-- Formato: N√∫mero entero

-- üéØ N√öMERO DE PRODUCTOS √öNICOS
-- Cuenta productos distintos comprados
N√∫mero Productos √önicos = 
DISTINCTCOUNT(FactCompras[Id])
-- Formato: N√∫mero entero

-- üìã N√öMERO DE √ìRDENES DE COMPRA
-- Cuenta √≥rdenes de compra √∫nicas
N√∫mero √ìrdenes Compra = 
DISTINCTCOUNT(FactCompras[Numero OC])
-- Formato: N√∫mero entero

-- üé´ TICKET PROMEDIO POR OC
-- Calcula el monto promedio por orden de compra
Ticket Promedio por OC = 
VAR TotalMonto = SUM(FactCompras[Monto Transado])
VAR NumeroOC = DISTINCTCOUNT(FactCompras[Numero OC])
RETURN
    DIVIDE(TotalMonto, NumeroOC, 0)
-- Formato: $ Espa√±ol, 2 decimales

-- üíµ MONTO PROMEDIO POR TRANSACCI√ìN
-- Calcula el monto promedio por l√≠nea de compra
Monto Promedio Transacci√≥n = 
AVERAGE(FactCompras[Monto Transado])
-- Formato: $ Espa√±ol, 2 decimales


-- ============================================================================
-- SECCI√ìN 2: AN√ÅLISIS TEMPORAL
-- ============================================================================

-- üìà MONTO A√ëO ACTUAL
-- Total del a√±o seleccionado en el contexto
Monto A√±o Actual = 
VAR AnioActual = MAX(DimCalendario[A√±o])
RETURN
    CALCULATE(
        SUM(FactCompras[Monto Transado]),
        DimCalendario[A√±o] = AnioActual
    )
-- Formato: $ Espa√±ol, 0 decimales

-- üìâ MONTO A√ëO ANTERIOR
-- Total del a√±o anterior al seleccionado
Monto A√±o Anterior = 
VAR AnioActual = MAX(DimCalendario[A√±o])
VAR AnioAnterior = AnioActual - 1
RETURN
    CALCULATE(
        SUM(FactCompras[Monto Transado]),
        DimCalendario[A√±o] = AnioAnterior
    )
-- Formato: $ Espa√±ol, 0 decimales

-- üìä VARIACI√ìN % YoY
-- Variaci√≥n porcentual a√±o sobre a√±o (Year over Year)
Variaci√≥n % YoY = 
VAR MontoActual = [Monto A√±o Actual]
VAR MontoAnterior = [Monto A√±o Anterior]
RETURN
    DIVIDE(
        MontoActual - MontoAnterior,
        MontoAnterior,
        0
    )
-- Formato: Porcentaje, 1 decimal

-- üìà MONTO ACUMULADO A√ëO
-- Monto acumulado desde inicio del a√±o hasta la fecha actual
Monto Acumulado A√±o = 
VAR FechaMax = MAX(DimCalendario[Fecha])
VAR AnioActual = YEAR(FechaMax)
RETURN
    CALCULATE(
        SUM(FactCompras[Monto Transado]),
        FILTER(
            ALL(DimCalendario),
            DimCalendario[A√±o] = AnioActual &&
            DimCalendario[Fecha] <= FechaMax
        )
    )
-- Formato: $ Espa√±ol, 0 decimales

-- üìÖ D√çAS DESDE √öLTIMA VENTA
-- Calcula d√≠as transcurridos desde la √∫ltima transacci√≥n
D√≠as Desde √öltima Venta = 
VAR UltimaFecha = MAX(FactCompras[Fecha])
VAR FechaHoy = TODAY()
RETURN
    DATEDIFF(UltimaFecha, FechaHoy, DAY)
-- Formato: N√∫mero entero

-- üìÜ MONTO MES ACTUAL
-- Total de compras del mes seleccionado
Monto Mes Actual = 
VAR MesActual = MAX(DimCalendario[Mes])
VAR AnioActual = MAX(DimCalendario[A√±o])
RETURN
    CALCULATE(
        SUM(FactCompras[Monto Transado]),
        DimCalendario[Mes] = MesActual,
        DimCalendario[A√±o] = AnioActual
    )
-- Formato: $ Espa√±ol, 0 decimales

-- üìä MONTO TRIMESTRE ACTUAL
-- Total de compras del trimestre seleccionado
Monto Trimestre Actual = 
VAR TrimestreActual = MAX(DimCalendario[Trimestre])
VAR AnioActual = MAX(DimCalendario[A√±o])
RETURN
    CALCULATE(
        SUM(FactCompras[Monto Transado]),
        DimCalendario[Trimestre] = TrimestreActual,
        DimCalendario[A√±o] = AnioActual
    )
-- Formato: $ Espa√±ol, 0 decimales


-- ============================================================================
-- SECCI√ìN 3: AN√ÅLISIS DE PROVEEDORES
-- ============================================================================

-- üèÜ MONTO POR PROVEEDOR
-- Suma de compras por proveedor (usar en tablas/gr√°ficos)
Monto por Proveedor = 
CALCULATE(
    SUM(FactCompras[Monto Transado])
)
-- Formato: $ Espa√±ol, 0 decimales

-- üìä % PARTICIPACI√ìN PROVEEDOR
-- Porcentaje que representa cada proveedor del total
% Participaci√≥n Proveedor = 
VAR MontoProveedor = [Monto por Proveedor]
VAR MontoTotal = 
    CALCULATE(
        SUM(FactCompras[Monto Transado]),
        ALL(DimProveedores)
    )
RETURN
    DIVIDE(MontoProveedor, MontoTotal, 0)
-- Formato: Porcentaje, 2 decimales

-- üéØ CONCENTRACI√ìN TOP 10 PROVEEDORES
-- Porcentaje de compras concentrado en top 10 proveedores
Concentraci√≥n Top 10 Proveedores = 
VAR Top10 = 
    CALCULATETABLE(
        TOPN(
            10,
            VALUES(DimProveedores[Rut Proveedor]),
            [Monto por Proveedor],
            DESC
        )
    )
VAR MontoTop10 = 
    CALCULATE(
        SUM(FactCompras[Monto Transado]),
        Top10
    )
VAR MontoTotal = SUM(FactCompras[Monto Transado])
RETURN
    DIVIDE(MontoTop10, MontoTotal, 0)
-- Formato: Porcentaje, 1 decimal

-- üí∞ PRECIO PROMEDIO PROVEEDOR
-- Precio promedio de productos vendidos por proveedor
Precio Promedio Proveedor = 
VAR MontoTotal = SUM(FactCompras[Monto Transado])
VAR CantidadTotal = SUM(FactCompras[Cantidad])
RETURN
    DIVIDE(MontoTotal, CantidadTotal, 0)
-- Formato: $ Espa√±ol, 2 decimales

-- üì¶ CANTIDAD VENDIDA PROVEEDOR
-- Total de unidades vendidas por proveedor
Cantidad Vendida Proveedor = 
SUM(FactCompras[Cantidad])
-- Formato: N√∫mero entero, separador de miles

-- üìã √ìRDENES POR PROVEEDOR
-- N√∫mero de √≥rdenes de compra por proveedor
√ìrdenes por Proveedor = 
DISTINCTCOUNT(FactCompras[Numero OC])
-- Formato: N√∫mero entero


-- ============================================================================
-- SECCI√ìN 4: AN√ÅLISIS DE PRODUCTOS
-- ============================================================================

-- üéØ MONTO POR PRODUCTO
-- Total de compras por producto
Monto por Producto = 
CALCULATE(
    SUM(FactCompras[Monto Transado])
)
-- Formato: $ Espa√±ol, 0 decimales

-- üì¶ CANTIDAD POR PRODUCTO
-- Total de unidades compradas por producto
Cantidad por Producto = 
SUM(FactCompras[Cantidad])
-- Formato: N√∫mero entero, separador de miles

-- üíé VALOR STOCK
-- Valor total de stock (Cantidad * Precio Promedio)
Valor Stock = 
SUMX(
    FactCompras,
    FactCompras[Cantidad] * FactCompras[Precio Promedio]
)
-- Formato: $ Espa√±ol, 0 decimales

-- üìä CLASIFICACI√ìN ABC PRODUCTO
-- Clasifica productos en A (80%), B (15%), C (5%) seg√∫n ventas
Clasificaci√≥n ABC = 
VAR MontoProducto = [Monto por Producto]
VAR MontoTotal = 
    CALCULATE(
        SUM(FactCompras[Monto Transado]),
        ALL(DimProductos)
    )
VAR PorcentajeAcumulado = 
    VAR ProductosSuperiores = 
        FILTER(
            ALL(DimProductos),
            [Monto por Producto] >= MontoProducto
        )
    VAR MontoAcumulado = 
        CALCULATE(
            SUM(FactCompras[Monto Transado]),
            ProductosSuperiores
        )
    RETURN
        DIVIDE(MontoAcumulado, MontoTotal, 0)
RETURN
    SWITCH(
        TRUE(),
        PorcentajeAcumulado <= 0.80, "A",
        PorcentajeAcumulado <= 0.95, "B",
        "C"
    )
-- Formato: Texto

-- üí∞ PRECIO PROMEDIO PRODUCTO
-- Precio promedio de un producto espec√≠fico
Precio Promedio Producto = 
AVERAGE(FactCompras[Precio Promedio])
-- Formato: $ Espa√±ol, 2 decimales

-- üìà VARIACI√ìN PRECIO PRODUCTO
-- Desviaci√≥n est√°ndar del precio del producto (volatilidad)
Variaci√≥n Precio Producto = 
STDEV.P(FactCompras[Precio Promedio])
-- Formato: $ Espa√±ol, 2 decimales

-- üîù RANKING PRODUCTO
-- Posici√≥n del producto por monto total
Ranking Producto = 
RANKX(
    ALL(DimProductos),
    [Monto por Producto],
    ,
    DESC,
    DENSE
)
-- Formato: N√∫mero entero


-- ============================================================================
-- SECCI√ìN 5: AN√ÅLISIS GEOGR√ÅFICO
-- ============================================================================

-- üó∫Ô∏è MONTO POR REGI√ìN
-- Total de compras por regi√≥n
Monto por Regi√≥n = 
CALCULATE(
    SUM(FactCompras[Monto Transado])
)
-- Formato: $ Espa√±ol, 0 decimales

-- üìä % DISTRIBUCI√ìN POR REGI√ìN
-- Porcentaje que representa cada regi√≥n del total
% Distribuci√≥n por Regi√≥n = 
VAR MontoRegion = [Monto por Regi√≥n]
VAR MontoTotal = 
    CALCULATE(
        SUM(FactCompras[Monto Transado]),
        ALL(DimRegiones)
    )
RETURN
    DIVIDE(MontoRegion, MontoTotal, 0)
-- Formato: Porcentaje, 2 decimales

-- üí∞ PRECIO PROMEDIO POR REGI√ìN
-- Precio promedio de productos en cada regi√≥n
Precio Promedio por Regi√≥n = 
VAR MontoTotal = SUM(FactCompras[Monto Transado])
VAR CantidadTotal = SUM(FactCompras[Cantidad])
RETURN
    DIVIDE(MontoTotal, CantidadTotal, 0)
-- Formato: $ Espa√±ol, 2 decimales

-- üì¶ CANTIDAD POR REGI√ìN
-- Total de unidades compradas por regi√≥n
Cantidad por Regi√≥n = 
SUM(FactCompras[Cantidad])
-- Formato: N√∫mero entero, separador de miles


-- ============================================================================
-- SECCI√ìN 6: MEDIDAS AUXILIARES Y AVANZADAS
-- ============================================================================

-- üéØ MEDIDA DE CONTROL - TOTAL REGISTROS
-- Cuenta el n√∫mero total de registros en la tabla de hechos
Total Registros = 
COUNTROWS(FactCompras)
-- Formato: N√∫mero entero, separador de miles

-- üìä CRECIMIENTO MES A MES
-- Variaci√≥n porcentual del mes actual vs mes anterior
Crecimiento Mes a Mes = 
VAR MontoMesActual = [Monto Mes Actual]
VAR MontoMesAnterior = 
    CALCULATE(
        SUM(FactCompras[Monto Transado]),
        DATEADD(DimCalendario[Fecha], -1, MONTH)
    )
RETURN
    DIVIDE(
        MontoMesActual - MontoMesAnterior,
        MontoMesAnterior,
        0
    )
-- Formato: Porcentaje, 1 decimal

-- üíπ √çNDICE DE ROTACI√ìN
-- Frecuencia de compra (n√∫mero de transacciones / productos √∫nicos)
√çndice Rotaci√≥n = 
VAR NumTransacciones = COUNTROWS(FactCompras)
VAR NumProductos = DISTINCTCOUNT(FactCompras[Id])
RETURN
    DIVIDE(NumTransacciones, NumProductos, 0)
-- Formato: N√∫mero decimal, 2 decimales


/*
================================================================================
C√ìMO USAR ESTAS MEDIDAS EN POWER BI
================================================================================

PASO 1: CREAR MEDIDAS
1. Abrir Power BI Desktop
2. Ir a la vista de "Datos" o "Informe"
3. Seleccionar la tabla FactCompras (o crear tabla separada "Medidas")
4. Clic en "Nueva medida" en la cinta
5. Copiar y pegar la f√≥rmula DAX
6. Presionar Enter

PASO 2: FORMATEAR MEDIDAS
Para medidas de montos ($):
- Seleccionar la medida
- Panel "Formato" > "N√∫mero" > "$ Espa√±ol"
- Decimales: 0 o 2 seg√∫n el caso

Para medidas de porcentaje (%):
- Panel "Formato" > "N√∫mero" > "Porcentaje"
- Decimales: 1 o 2

Para medidas de cantidad:
- Panel "Formato" > "N√∫mero" > "N√∫mero entero"
- Activar "Separador de miles"

PASO 3: ORGANIZAR MEDIDAS
Crear carpetas de visualizaci√≥n:
- KPIs Principales
- An√°lisis Temporal
- Proveedores
- Productos
- Geogr√°fico

PASO 4: USAR EN VISUALIZACIONES
- Arrastrar medidas a tarjetas para KPIs
- Usar en ejes de gr√°ficos para an√°lisis
- Combinar con dimensiones para segmentaci√≥n
- Aplicar en tablas para reportes detallados

================================================================================
OPTIMIZACIONES Y BUENAS PR√ÅCTICAS APLICADAS
================================================================================

‚úÖ Uso de variables (VAR) para mejorar rendimiento y legibilidad
‚úÖ DIVIDE con manejo de divisi√≥n por cero
‚úÖ ALL para remover filtros cuando es necesario
‚úÖ CALCULATE para cambiar contexto de filtro
‚úÖ FILTER para filtros complejos con mejor rendimiento que m√∫ltiples AND
‚úÖ Nombres descriptivos en espa√±ol para facilitar comprensi√≥n
‚úÖ Comentarios explicativos para cada medida
‚úÖ Formatos sugeridos para cada tipo de medida
‚úÖ Medidas escalables para ~38,000 registros

================================================================================
MEDIDAS RECOMENDADAS PARA CADA DASHBOARD
================================================================================

üìä DASHBOARD 1: RESUMEN EJECUTIVO
- Total Monto Transado
- N√∫mero Proveedores √önicos
- N√∫mero Productos √önicos
- Ticket Promedio por OC
- Variaci√≥n % YoY
- Monto Acumulado A√±o

üìà DASHBOARD 2: AN√ÅLISIS DE PROVEEDORES
- Monto por Proveedor
- % Participaci√≥n Proveedor
- Concentraci√≥n Top 10 Proveedores
- Precio Promedio Proveedor
- Cantidad Vendida Proveedor
- √ìrdenes por Proveedor

üéØ DASHBOARD 3: AN√ÅLISIS DE PRODUCTOS
- Monto por Producto
- Cantidad por Producto
- Clasificaci√≥n ABC
- Valor Stock
- Precio Promedio Producto
- Ranking Producto

üó∫Ô∏è DASHBOARD 4: AN√ÅLISIS GEOGR√ÅFICO
- Monto por Regi√≥n
- % Distribuci√≥n por Regi√≥n
- Precio Promedio por Regi√≥n
- Cantidad por Regi√≥n

üìÖ DASHBOARD 5: AN√ÅLISIS TEMPORAL
- Monto A√±o Actual
- Monto A√±o Anterior
- Variaci√≥n % YoY
- Monto Acumulado A√±o
- Monto Mes Actual
- Crecimiento Mes a Mes

================================================================================
SOLUCI√ìN DE PROBLEMAS
================================================================================

‚ùå Error: "No se puede determinar el valor"
‚úÖ Soluci√≥n: Verificar que las relaciones est√°n bien configuradas

‚ùå Error: "Referencia circular"
‚úÖ Soluci√≥n: No usar la misma medida dentro de su propia definici√≥n

‚ùå Medida devuelve valor incorrecto
‚úÖ Soluci√≥n: Revisar el contexto de filtro con ALL() o ALLEXCEPT()

‚ùå Rendimiento lento
‚úÖ Soluci√≥n: Usar variables VAR y evitar FILTER cuando sea posible

‚ùå Divisi√≥n por cero
‚úÖ Soluci√≥n: Siempre usar DIVIDE con tercer par√°metro (valor por defecto)

================================================================================
FIN DEL ARCHIVO DE MEDIDAS DAX
================================================================================
*/
